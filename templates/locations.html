{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Locations</h2>
    <a href="{{ url_for('add_location') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add Location
    </a>
</div>

<!-- Search Bar -->
<div class="card mb-3">
    <div class="card-body">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search"></i>
            </span>
            <input type="text" 
                   id="searchInput" 
                   class="form-control border-start-0" 
                   placeholder="Search by Location ID or Name..."
                   onkeyup="searchTable()">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                <i class="bi bi-x-circle"></i> Clear
            </button>
        </div>
        <small class="text-muted mt-2 d-block">
            <span id="resultCount"></span>
        </small>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if locations %}
        <div class="table-responsive">
            <table class="table table-striped" id="locationsTable">
                <thead>
                    <tr>
                        <th>Location ID</th>
                        <th>Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for location in locations %}
                    <tr style="cursor: pointer;" onclick="showLocationInventory('{{ location.location_id }}', '{{ location.name }}')">
                        <td><code>{{ location.location_id }}</code></td>
                        <td>{{ location.name }}</td>
                        <td onclick="event.stopPropagation();">
                            <div class="btn-group">
                                <a href="{{ url_for('edit_location', location_id=location.location_id) }}" 
                                   class="btn btn-primary btn-sm">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                <form method="POST" action="{{ url_for('delete_location', location_id=location.location_id) }}" 
                                      style="display: inline;" onsubmit="return confirm('Delete this location?')">
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="noResults" style="display: none;" class="text-center py-4">
            <i class="bi bi-search display-1 text-muted"></i>
            <p class="text-muted mt-3">No locations found matching your search.</p>
        </div>
        {% else %}
        <p class="text-center text-muted">No locations found. <a href="{{ url_for('add_location') }}">Add the first one!</a></p>
        {% endif %}
    </div>
</div>

<!-- Modal for Location Inventory -->
<div class="modal fade" id="inventoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #9b87f5 0%, #7e69c1 100%);">
                <h5 class="modal-title text-white">
                    <i class="bi bi-box-seam me-2"></i>
                    <span id="modalLocationName"></span> - Inventory
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="inventoryLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading inventory...</p>
                </div>
                <div id="inventoryContent" style="display: none;">
                    <div class="mb-3">
                        <input type="text" 
                               id="inventorySearch" 
                               class="form-control" 
                               placeholder="Search products in this location..."
                               onkeyup="searchInventory()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Product ID</th>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th class="text-end">Quantity</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="noInventory" style="display: none;" class="text-center py-4">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="text-muted mt-3">No products available in this location.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    tr[onclick]:hover {
        background-color: rgba(155, 135, 245, 0.1) !important;
    }
    
    #inventoryTable tbody tr {
        cursor: default;
    }
</style>

<script>
let currentInventoryData = [];

function searchTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('locationsTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = tbody.getElementsByTagName('tr');
    const noResults = document.getElementById('noResults');
    const resultCount = document.getElementById('resultCount');
    
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const locationId = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
        const locationName = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();
        
        if (locationId.includes(filter) || locationName.includes(filter)) {
            rows[i].style.display = '';
            visibleCount++;
        } else {
            rows[i].style.display = 'none';
        }
    }
    
    // Show/hide no results message
    if (visibleCount === 0 && filter !== '') {
        table.style.display = 'none';
        noResults.style.display = 'block';
        resultCount.textContent = 'No results found';
    } else {
        table.style.display = 'table';
        noResults.style.display = 'none';
        if (filter !== '') {
            resultCount.textContent = `Showing ${visibleCount} of ${rows.length} locations`;
        } else {
            resultCount.textContent = `Total: ${rows.length} locations`;
        }
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    searchTable();
}

function showLocationInventory(locationId, locationName) {
    // Set modal title
    document.getElementById('modalLocationName').textContent = locationName;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
    modal.show();
    
    // Show loading, hide content
    document.getElementById('inventoryLoading').style.display = 'block';
    document.getElementById('inventoryContent').style.display = 'none';
    
    // Fetch balance report data
    fetch('{{ url_for("balance_report") }}')
        .then(response => response.text())
        .then(html => {
            // Parse the HTML to extract balance data
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const table = doc.querySelector('table');
            
            if (!table) {
                showNoInventory();
                return;
            }
            
            const rows = table.querySelectorAll('tbody tr');
            currentInventoryData = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    const productName = cells[0].querySelector('strong').textContent.trim();
                    const productId = cells[0].querySelector('small').textContent.trim();
                    const locName = cells[1].childNodes[0].textContent.trim();
                    const locId = cells[1].querySelector('small').textContent.trim();
                    const quantity = cells[2].querySelector('span').textContent.replace(' units', '').trim();
                    
                    if (locId === locationId) {
                        currentInventoryData.push({
                            productId: productId,
                            productName: productName,
                            category: '',
                            quantity: quantity
                        });
                    }
                }
            });
            
            // Fetch product details to get categories
            fetch('{{ url_for("products") }}')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const productTable = doc.querySelector('table');
                    
                    if (productTable) {
                        const productRows = productTable.querySelectorAll('tbody tr');
                        const productMap = {};
                        
                        productRows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length >= 3) {
                                const prodId = cells[0].textContent.trim();
                                const category = cells[2].textContent.trim();
                                productMap[prodId] = category;
                            }
                        });
                        
                        // Add categories to inventory data
                        currentInventoryData.forEach(item => {
                            item.category = productMap[item.productId] || 'N/A';
                        });
                    }
                    
                    displayInventory();
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                    displayInventory();
                });
        })
        .catch(error => {
            console.error('Error fetching inventory:', error);
            showNoInventory();
        });
}

function displayInventory() {
    document.getElementById('inventoryLoading').style.display = 'none';
    document.getElementById('inventoryContent').style.display = 'block';
    
    const tbody = document.getElementById('inventoryTableBody');
    tbody.innerHTML = '';
    
    if (currentInventoryData.length === 0) {
        document.getElementById('inventoryTable').style.display = 'none';
        document.getElementById('noInventory').style.display = 'block';
        return;
    }
    
    document.getElementById('inventoryTable').style.display = 'table';
    document.getElementById('noInventory').style.display = 'none';
    
    currentInventoryData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><code>${item.productId}</code></td>
            <td><strong>${item.productName}</strong></td>
            <td>${item.category}</td>
            <td class="text-end">
                <span class="badge bg-success" style="font-size: 0.9rem;">
                    ${item.quantity} units
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    document.getElementById('inventorySearch').value = '';
}

function showNoInventory() {
    document.getElementById('inventoryLoading').style.display = 'none';
    document.getElementById('inventoryContent').style.display = 'block';
    document.getElementById('inventoryTable').style.display = 'none';
    document.getElementById('noInventory').style.display = 'block';
}

function searchInventory() {
    const input = document.getElementById('inventorySearch');
    const filter = input.value.toLowerCase();
    const tbody = document.getElementById('inventoryTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const productId = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
        const productName = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();
        const category = rows[i].getElementsByTagName('td')[2].textContent.toLowerCase();
        
        if (productId.includes(filter) || productName.includes(filter) || category.includes(filter)) {
            rows[i].style.display = '';
            visibleCount++;
        } else {
            rows[i].style.display = 'none';
        }
    }
    
    if (visibleCount === 0 && filter !== '') {
        document.getElementById('inventoryTable').style.display = 'none';
        document.getElementById('noInventory').style.display = 'block';
        document.getElementById('noInventory').innerHTML = `
            <i class="bi bi-search display-1 text-muted"></i>
            <p class="text-muted mt-3">No products found matching "${filter}".</p>
        `;
    } else if (currentInventoryData.length > 0) {
        document.getElementById('inventoryTable').style.display = 'table';
        document.getElementById('noInventory').style.display = 'none';
    }
}

// Initialize result count on page load
document.addEventListener('DOMContentLoaded', function() {
    searchTable();
});
</script>
{% endblock %}